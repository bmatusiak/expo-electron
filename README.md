# expo-electron

Dev helper that integrates an Expo web app with Electron for development and deterministic packaging.

Quick commands (run from the project root):

- `npm install` — ensure project dependencies are installed so `expo`, `electron`, and `electron-forge` are available in `node_modules/.bin`.
- `npx expo-electron prebuild` — create/update `electron/` from the bundled template (never overwrites existing files).
- `npx expo-electron autolink` — generate `electron/main/preload.js` and `electron/electron-resources.json`.
- `npx expo-electron start` — run `expo start --web`, wait for the dev server, then launch Electron.
- `npx expo-electron package` — export web, assemble a deterministic Forge workspace, and run `electron-forge package`.
  - Add `--make zip,deb` (etc) to also run `electron-forge make` for final distributables.

How it works (high level)

- Prebuild: copies the bundled template `main/` into `electron/main/`, but skips `preload.js` (preload is generated by autolink) and never overwrites existing files. Creates `electron/.gitignore` that ignores the packaging output folder.
- Dev (`start`):
  - Runs `prebuild` and then (best-effort) `npm rebuild` at the project root.
  - Runs autolink into `electron/`.
  - Starts `expo start --web`, waits for `EXPO_WEB_URL` (default `http://localhost:8081`), then launches Electron with `NODE_ENV=development`.
  - Electron is launched from the project `electron/` folder and is pointed at `electron/main/preload.js` via `EXPO_PRELOAD_PATH`.
- Packaging (`package`):
  - Runs `prebuild` + autolink.
  - Exports the web build into `electron/build/app/` (folder name configurable).
  - Post-processes `app/index.html` for `file://` compatibility.
  - Copies `electron/main/` into the packaging workspace `electron/build/main/` and bundles `main.js` + `preload.js` with `esbuild` (unless disabled).
  - Creates a minimal `electron/build/package.json` with a deterministic Forge config and runs `electron-forge package` (and optionally `make`).

Build / workspace locations

- Project Electron sources live at `electron/` (created by `prebuild`).
- Packaging workspace defaults to `electron/build/`.
  - Override the folder name with `EXPO_ELECTRON_BUILD_DIR` (default: `build`).
  - Web export goes to `electron/build/app/`.
  - Forge outputs go under `electron/build/out/` (distributables at `electron/build/out/make/`).

Environment variables

- `EXPO_WEB_URL` (default: `http://localhost:8081`) — dev server URL Electron should load in development (used by `start` and `main/main.js`).
- `EXPO_PRELOAD_PATH` (default: `electron/main/preload.js` when launched by `start`) — path to the preload script used at runtime (used by `main/main.js`).
- `EXPO_ELECTRON_BUILD_DIR` (default: `build`) — folder name under `electron/` used as the packaging workspace (used by `package`).
- `EXPO_ELECTRON_NO_BUNDLE_MAIN` — disable `esbuild` bundling of `main/main.js` (set to `1`/`true`/`yes`).
- `EXPO_ELECTRON_NO_BUNDLE_PRELOAD` — disable `esbuild` bundling of `main/preload.js` (set to `1`/`true`/`yes`).
- `EXPO_ELECTRON_NO_CSP` — disable CSP injection (export-time meta tag) and runtime CSP header install (set to `1`/`true`/`yes`).
- `EXPO_ELECTRON_CSP` — override the Content Security Policy string.
- `EXPO_ELECTRON_PROTOCOLS` (or `EXPO_ELECTRON_PROTOCOL`) — comma-separated list of URL schemes to register (example: `myapp,myapp-dev`).
- `EXPO_ELECTRON_NO_SINGLE_INSTANCE` — disable single-instance behavior (Windows/Linux deep linking relies on single-instance handoff).
- `EXPO_ELECTRON_COPY_NATIVE_ONLY` — copy only `*.node` files from all autolink resources (set to `1`/`true`/`yes`).
- `EXPO_ELECTRON_NO_EXTRA_RESOURCE_NATIVE` — do not ship `native/` as a Forge `extraResource` (set to `1`/`true`/`yes`).

Deep linking (URL schemes)

- Main process: `main/main.js` registers protocols (via `app.setAsDefaultProtocolClient`), captures incoming URLs (`open-url` on macOS, `second-instance` argv on Windows/Linux), and forwards them to the renderer with IPC channel `on-deep-link`.
- Preload: the autolinker generates a `window.electron.onDeepLink((url) => ...)` helper that strips the Electron IPC event object and only passes the URL string.
- Configuration: `expo.scheme` (or `expo.schemes`) from `app.json` is used when available; packaged builds also embed the configured scheme(s) into the generated packaging workspace `package.json` under `expoElectron.protocols`.

Deterministic packaging details

- Web export: uses the installed Expo CLI's `export` command; if `export` is not available it fails loudly rather than guessing alternatives.
- Post-export transformations (for `file://`):
  - If missing, a `<base href="./">` is injected.
  - Root-absolute `src`/`href` values (for example `/_expo/...`) are rewritten to relative (`./_expo/...`).
  - A CSP `<meta http-equiv="Content-Security-Policy" ...>` is injected by default (see **CSP**).
- Forge workspace: `electron/build/package.json` is generated and the CLI always runs `electron-forge package`. The `electron-forge make` step only runs when `--make` is provided.

Main/preload bundling

- During `npx expo-electron package`, the CLI bundles `electron/build/main/main.js` and `electron/build/main/preload.js` using `esbuild` so main/preload dependencies are included without relying on workspace `node_modules`.
- Disable bundling with `EXPO_ELECTRON_NO_BUNDLE_MAIN=1` and/or `EXPO_ELECTRON_NO_BUNDLE_PRELOAD=1`.

Native resources & ASAR behavior

- Autolink currently focuses on native addon binaries (`*.node`).
  - It writes an `electron/electron-resources.json` manifest mapping project-relative `from` paths to `native/<package>/...` destinations in the packaging workspace.
- Packaging copies those resources into the Forge workspace.
  - For sources under `build/Release` and `build/Debug`, only `*.node` files are copied.
  - Set `EXPO_ELECTRON_COPY_NATIVE_ONLY=1` to copy only `*.node` files from all autolink resources.
- The generated Forge config uses `asar: true` and ignores `native/` inside the app bundle, then (by default) ships `native/` as an `extraResource` so native binaries are outside `app.asar`.
  - Disable copying `native/` as an extraResource with `EXPO_ELECTRON_NO_EXTRA_RESOURCE_NATIVE=1`.

Package examples

- Run packaging only (no distributables):

  `npx expo-electron package`

- Run packaging and produce only `zip` and `deb` distributables:

  `npx expo-electron package --make zip,deb`

- The CLI filters makers by fuzzy name matching (e.g. `zip` matches `@electron-forge/maker-zip`). If no matching makers are found the `make` step is skipped.

Available makers (tokens)

- `squirrel` — `@electron-forge/maker-squirrel` (Windows/Squirrel)
- `zip` — `@electron-forge/maker-zip` (Zip archive)
- `deb` — `@electron-forge/maker-deb` (Debian package)
- `rpm` — `@electron-forge/maker-rpm` (RPM package)

Autolinking native/electron modules

This package includes an `autolink` helper that scans the project's top-level dependencies (only those declared in the project's `package.json`) and links packages that have `electron/index.js`.

- Detection: only considers packages installed at `projectRoot/node_modules/<name>` and only links those with `electron/index.js`.
- Preload generation: writes a generated preload script.
  - Default output is `src/preload.js`.
  - When targeting a prebuild folder it writes `electron/main/preload.js`.
  - The preload exposes `ElectronNative` via `contextBridge.exposeInMainWorld('ElectronNative', ElectronNative)`.
  - In development it tries to `require()` the module via `require.resolve('<name>/electron')` (fallback: `require.resolve('<name>')`).
  - In production it prefers loading any shipped `*.node` binary from `resources/native/<name>/...`.
  - If nothing loads, a `{ _missing: true }` placeholder is exposed.

Production runtime behavior

- `main/main.js` prefers loading a production `app/index.html` (packaged web export). If that file is present the app will load locally; if not, and `NODE_ENV` is `development`, it will attempt to load the dev server URL from `EXPO_WEB_URL`.
- If neither a production index nor a dev server is available the process exits with a non-zero code — this prevents silent fallbacks.

CSP

- Packaged builds: `package` injects a CSP `<meta http-equiv="Content-Security-Policy" ...>` into the exported `app/index.html`.
- Runtime: `main/main.js` also installs CSP as a response header (for both dev and prod loads).
- Disable CSP with `EXPO_ELECTRON_NO_CSP=1`.
- Override the policy with `EXPO_ELECTRON_CSP`.

Troubleshooting

- Missing binaries: the CLI checks for `expo`, `electron`, and `electron-forge` in `node_modules/.bin` and fails with actionable messages if they are missing. Run `npm install` at the project root first.
- File not found errors after packaging: verify `electron/build/app/index.html` exists and contains a `<base href="./">`, and confirm static assets exist under `electron/build/app/_expo` (or the expected relative paths).
- Autolink issues: the autolinker only considers packages installed at the project's top-level `node_modules`. If a package is nested or not declared in `package.json`, it will be skipped.

Developer notes

- The tool intentionally favors deterministic, fail-fast behavior: it validates the environment and fails loudly if an expected command or file is unavailable.
- The `electron/` folder is intended to be edited by developers; once created the CLI will not overwrite your edits — with two exceptions:
  1. The packaging output under `electron/build/` is regenerated by packaging.
  2. Autolink-generated artifacts (for example `electron/main/preload.js` and `electron/electron-resources.json`) may be regenerated and should not be edited directly.

Where to look in the code

- Autolink logic: [lib/autolink.js](lib/autolink.js#L1)
- CLI entry and packaging flow: [cli.js](cli.js#L1)
- Electron template main: [main/main.js](main/main.js#L1)
